---
title: "2014 US Births Analysis"
output:
  github_document: default
---

```{r}
knitr::opts_chunk$set(echo = TRUE, results = 'show', warning = FALSE, message = FALSE)
```

## Housekeeping Tasks

```{r housekeeping}
# clear environment
rm(list = ls())

# packages
myPackages <- c("openintro","tidyverse", "patchwork", "ggthemes", "psych", "corrplot", "GGally", "car", "MASS", "logistf")

# get packages if necessary
#install.packages(myPackages)

# load packages
lapply(myPackages, require, character.only=TRUE)

# not necessary, I just don't care for the warnings
options(warn = -1)
```

```{r get dataset}
births <- openintro::births14
```

## Exploratory Data Analysis

```{r investigating}
# find the describe function to be very useful, preferred visually
describe(births)

# since it doesnt make NAs clear though:
sum(is.na((births))) # know I have 231 missing values
births[!complete.cases(births), ] # returns 206 rows, so at least 2 missing values
missingValues <- as.data.frame(colSums(is.na(births)))
missingValues %>%
  filter(`colSums(is.na(births))` > 0)
```

### Encoding of Variables

-   categorical: mature, premie, lowbirthweight, sex, habit, marital, whitemom

-   interval: weeks

-   ratio: fage, mage, visits, gained, weight

### Missing Values Observations:

-   Father's age accounts for \~49% of our missing data

-   Visits to the hospital account for \~24%

-   Weight Gained by the mother is \~18%

-   Smoking Habit covers \~8%

```{r cleaning}
# handle factoring
factoringCols <- c("mature", "premie", "lowbirthweight", "sex", "habit", "marital", "whitemom")
births[factoringCols] <- lapply(births[factoringCols], factor)
sapply(births, class)

# cleaning of NAs
birthsCleaned <- births %>%
  drop_na()

str(birthsCleaned)
```

```{r}
head(birthsCleaned, 5)
tail(birthsCleaned, 5)
```

### Bar Plots for Categorical Data

```{r assessing categoricals}
table(birthsCleaned$mature) # moms are generally younger
table(birthsCleaned$premie) # babies are usually full term
table(birthsCleaned$lowbirthweight) # most are not of low birthweight
table(birthsCleaned$sex) # sex of the baby is around even
table(birthsCleaned$habit) # most are nonsmokers
table(birthsCleaned$marital) # most are married at birth but still, around even
table(birthsCleaned$whitemom) # most participants are white

# graphing with ggplot
graphMature <- ggplot(birthsCleaned, aes(mature)) + geom_bar(stat = "count") + geom_text(stat = "count", aes(label = after_stat(count)), vjust = 1, size = 2.75)
graphPremie <- ggplot(birthsCleaned, aes(premie)) + geom_bar(stat = "count") + geom_text(stat = "count", aes(label = after_stat(count)), vjust = 1, size = 2.75)
graphLowBW <- ggplot(birthsCleaned, aes(lowbirthweight)) + geom_bar(stat = "count") + geom_text(stat = "count", aes(label = after_stat(count)), vjust = 0.8, size = 2.75)
graphSex <- ggplot(birthsCleaned, aes(sex)) + geom_bar(stat = "count")  + geom_text(stat = "count", aes(label = after_stat(count)), vjust = 1, size = 2.75)
graphHabit <- ggplot(birthsCleaned, aes(habit)) + geom_bar(stat = "count") + geom_text(stat = "count", aes(label = after_stat(count)), vjust = 1, size = 2.75)
graphMarital <- ggplot(birthsCleaned, aes(marital)) + geom_bar(stat = "count")  + geom_text(stat = "count", aes(label = after_stat(count)), vjust = 1, size = 2.75)
graphWhite <- ggplot(birthsCleaned, aes(whitemom)) + geom_bar(stat = "count") + geom_text(stat = "count", aes(label = after_stat(count)), vjust = 1, size = 2.75)

graphMature + graphPremie + graphLowBW + graphSex + graphHabit + graphMarital + graphWhite + plot_layout(ncol = 3) & theme_pander()
```

Notes: Not too much interesting in these graphs

Potential Later Inquiries: perhaps might find something in further segmentation like by low birth weight by child sex, mother maturity, mother race, marital status

### Histograms for Numerical Data

```{r assessing numericals visually}
par(mfrow = c(2, 3), mar = c(3,5,3,5))
hist(birthsCleaned$fage,
  xlab = "Age",
  main = "Father's Age at Birth",
  col = "deepskyblue2"
)
hist(birthsCleaned$mage,
  xlab = "Age",
  main = "Mother's Age at Birth",
  col = "forestgreen"
)
hist(birthsCleaned$weeks,
  xlab = "Weeks",
  main = "Pregnancy in Weeks",
  col = "coral"
)
hist(birthsCleaned$visits,
  xlab = "Visits",
  main = "Hospital Visits \nduring Pregnancy",
  col = "darkgoldenrod"
)
hist(birthsCleaned$gained,
  xlab = "Weight (lbs)",
  main = "Weight Gained by Mother \nduring Pregnancy",
  col = "aquamarine"
)
hist(birthsCleaned$weight,
  xlab = "Weight (lbs)",
  main = "Baby Weight at Birth",
  col = "cadetblue"
)
par(mfrow = c(4, 2), mar = c(3,5,3,5))
boxplot(birthsCleaned$fage,
  xlab = "Age",
  horizontal = TRUE,
  pch = 16,
  col = "deepskyblue2", 
  main = "Father's Age at Birth"
)
boxplot(birthsCleaned$mage,
  xlab = "Age",
  horizontal = TRUE,
  pch = 16,
  col = "forestgreen", 
  main = "Mother's Age at Birth" # informative title
) 
boxplot(birthsCleaned$weeks,
  xlab = "Weeks",
  horizontal = TRUE,
  pch = 16,
  col = "coral", 
  main = "Pregnancy in Weeks" # informative title
) 
boxplot(birthsCleaned$visits,
  xlab = "Visits",
  horizontal = TRUE,
  pch = 16,
  col = "darkgoldenrod", 
  main = "Hospital Visits \nduring Pregnancy" # informative title
) 
boxplot(birthsCleaned$gained,
  xlab = "Weight (lbs)",
  horizontal = TRUE,
  pch = 16,
  col = "aquamarine", 
  main = "Weight Gained by Mother \nduring Pregnancy" # informative title
) 
boxplot(birthsCleaned$weight,
  xlab = "Weight (lbs)",
  horizontal = TRUE,
  pch = 16,
  col = "cadetblue", 
  main = "Baby Weight at Birth" # informative title
)
```

Two different ways of expressing similar concepts but I personally feel the boxplots to be a bit more informative in that it makes our outliers clearer in context of the lower/upper ranges of "normal" for the population.

Some observations:

-   Appear to be pretty normally distributed with some small skews

    -   *Pregnancy in Weeks* is skewed to the left

    -   *Weight Gained by Mother during Pregnancy* is skewed to the right.

    -   Either way, that means correlations later can be on default of Pearson's

-   Fathers tend to be older than mothers

-   If they're an outlier, more likely that the pregnancy will be shorter than longer.

-   Mothers are more likely to gain more weight than "normal" while babies are more likely to have lower weights at birth than "normal"

## Testing

### Random Sampling

```{r random sampling}
# would strongly prefer to not have to edit my analysis every rerun, thanks
set.seed(42)
# only ~10% to ensure that things remain cool, independence wise
sampleBirths <- birthsCleaned[sample(nrow(birthsCleaned), 79, replace = FALSE), ]
describe(sampleBirths)
```

## Correlations

```{r correlation matrix}
# take only columns that are numeric, make correlation matrix, round each value to 3 decimal places
corMatrix <- round(cor(sampleBirths[,sapply(sampleBirths,is.numeric)]), 3)
corMatrix
```

No part of me is surprised by the seemingly tight correlation between mother's age and father's age, that is how that usually goes.

Correlation matrix confirms what we would have thought about the mother's and father's age at a moderate-to-strong 0.77. And based on the graphs, I didn't fully expect much to come from this in that manner, everything does look pretty scattered. The baby's weight and weeks of pregnancy are the strongest correlation on the board (other than the obvious of correlation with the same variable), which makes sense as they've had a bit more time to bake in the oven.

Focusing in on the birth weight and the gestation period, we can look at something like that by smoker status or maternal race.

```{r}
ggplot(sampleBirths, aes(x = weeks, y = weight, color = habit)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_pander() +
  labs(title = "Birth Weight vs. Gestation by Smoking Status", 
       x = "Gestation (weeks)", 
       y = "Weight (lbs)")
ggplot(sampleBirths, aes(x = weeks, y = weight, color = whitemom)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_pander() +
  labs(title = "Birth Weight vs. Gestation by Maternal Race", 
       x = "Gestation (weeks)", 
       y = "Weight (lbs)")
```

```{r}
round(cor(sampleBirths[1:50,sapply(sampleBirths,is.numeric)]), 2)
```

The second had nothing to do with anything really, it was just interesting to see how little it takes to change the numbers. While not by much, mother and father's ages are more correlated; also the mother's weight gained is now more strongly correlated with the baby's birth weight.

#### Visualize the correlation matrix

```{r}
corrplot(corMatrix, method = 'color', type = "lower", addCoef.col = 'black', tl.col = 'black', number.cex = 0.8)
```

```{r}
ggpairs(sampleBirths[,sapply(sampleBirths,is.numeric)],
        upper = list(continuous = 'cor'),
        title = "Pairwise Scatterplots with Correlations")
```

By the graph's determination, mage/fage, weight/weeks, mother's weight gained and baby's weight at birth were most correlated

`gained` and `weight` (does more maternal weight gain mean heavier babies?)

```{r}
# Scatter plot: gained vs. weight by marital status
ggplot(sampleBirths, aes(x = gained, y = weight, color = marital)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_pander() +
  labs(title = "Maternal Weight Gain vs. Baby Weight by Marital Status",
       x = "Maternal Weight Gain (lbs)",
       y = "Baby Weight (oz)")
# by smoker status
ggplot(sampleBirths, aes(x = gained, y = weight, color = habit)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_pander() +
  labs(title = "Maternal Weight Gain vs. Baby Weight by Smoking Habit",
       x = "Maternal Weight Gain (lbs)",
       y = "Baby Weight (oz)")
# by maternal race
ggplot(sampleBirths, aes(x = gained, y = weight, color = whitemom)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_pander() +
  labs(title = "Maternal Weight Gain vs. Baby Weight by Maternal Race", 
       x = "Maternal Weight Gain (lbs)",
       y = "Baby Weight (oz)")
```

-   Appears to be no relationship between baby's weight at birth and mother's weight when the mother is married but a weak relationship between the two when the mother is married.

-   As it relates to smoking, there does seem to be a relationship but it is far weaker for nonsmokers than smokers.

-   The same is true for race, weak for not white moms but slightly stronger for white moms.

## Regressions

```{r level checks}
levels(sampleBirths$lowbirthweight)

```

### Simple Linear

Going to look at the effects on the baby's birth weight using a linear regression model. I will place more in the model but I was more interested in the weight and weeks connection. Also interested in the visits.

```{r}
modelWeeks <- lm(weight ~ weeks, data = sampleBirths)
summary(modelWeeks)
plot(modelWeeks)
```

Intercept: when weeks is zero, we predict the baby's birth weight to be -0.92 lbs. Considering that birth at zero weeks *should* mean that the baby has no birth weight, and that birth at this time would be categorized as a completely different medical event, but is *negative* makes the output not biologically meaningful. It is also not statistically significant.

Weeks: We predict that baby's birth weight to, on average, increase by 0.21 for each week spent gestating. This makes sense as if the baby stays in for longer, they have more time to grow. This is also indicated to be statistically significant.

R\^2: This value indicates that weeks explains as much as 19% of the variation.

F-statistic: It is statistically significant overall so gestational length is a meaningful predictor of birth weight.

Residuals: The prediction is usually around 1lb either direction.

```{r}
modelVisits <- lm(weight ~ visits, data = sampleBirths)
summary(modelVisits)
```

The intercept is significant but not all that important to the interpretation as the number of visits isn't normally in this social context but it is possible.

This predictor turned out to be insignificant on its own but if it were, we'd predict that baby's birth weight to decrease by 0.05 lbs for each visit during pregnancy. Additionally it only accounts for 2.5% of the variation in birth weight which is very weak power.

At zero visits, we predict that the baby's weight would be 7.88 lbs, which is a pretty good thing as that is around the mean and is within weight for full term babies! Nonetheless, while plausible, it isn't an indication of being causal.

The residuals here, in context, indicates the error is 1.16 lbs, which is large compared to an effect size of 0.056 lbs per visit, and may explain the lack of statistical significance.

### Multiple Linear

Let's see if there's anything we can add to weeks to generate a better result.

```{r}
# put everything in
modelMultiple <- lm(weight ~ weeks + gained + mage + fage + visits + mature + premie + lowbirthweight + sex + habit + marital + whitemom, data = sampleBirths)
summary(modelMultiple)
plot(modelMultiple)
```

But first, make sure the assumptions are met if we put everything in

```{r}
hist(modelMultiple$residuals)
```

Appears to be normally distributed for the most part, even if somewhat tailed, which I would think to be fair considering that I did remove all incomplete data from the beginning and I'm not using the full data set currently. Appears to be reasonably linear. Already looked at the correlations and they're so low that I'm not super concerned about multicollinearity; however, with consideration to my analysis focusing on the baby's birth weight, of course I should reasonably expect that the value of low birth weight to correlate with the baby's birth weight and as a result, it is my first removal from the model once we get to that point.

```{r}
# check for homoscedasticity
breushpaganTest <- ncvTest(modelMultiple)
breushpaganTest
```

Using the Breush-Pagan test on the basis of my multiple linear regression model, the p-value is greater than 0.05 so we're failing to reject the null hypothesis and assuming then that the variance of the residual errors is similar across each independent variable.

We can continue forward.

Due to the fact that the results of the first were likely skewed, to a degree, by the lowbirthweight variable, this is the new basis for assessment.

```{r}
modelMultiple2 <- lm(weight ~ weeks + gained + mage + fage + visits + mature + premie + sex + habit + marital + whitemom, data = sampleBirths)
summary(modelMultiple2)
```

Intercept: yes.

Weeks: Essentially no effect on birth weight when combined with other predictors.

Without significant effect: maternal weight gain; maternal age, despite being slightly negative association; paternal age; younger mothers, despite weighing slightly less; smoking, marital status of the mother, race of the mother

Premie: \~1.96 lbs less and is highly significant

Sex of the infant: Males weight \~0.6 lbs more than females and is significant

This model explains \~38% of the variation in birth weight but adjusted for the number of predictors, it drops to \~28%. While still statistically significant, it indicates that there are other factors not included explain a larger portion of the infant weight variance.

The first model's summary indicated that we should remove: weeks, whitemom, habitsmoker, fage, gained and more but we're starting with those.

```{r}
modelMultiple3 <- lm(weight ~ mage + visits + mature + premie + sex + marital, data = sampleBirths)
summary(modelMultiple3)
```

This is good, the residual has decreased and the adjusted r-squared value has increased to \~32%, which means that it's likely a better fit than before. It still does not explain more of the model, of course.

To confirm further reduction, it is limited to premie and sex.

```{r}
modelMultiple4 <- lm(weight ~ premie + sex, data = sampleBirths)
summary(modelMultiple4)
```

We can expect that the model is still highly significant but our r-squared values decreased and out residual increased so there may be a loss somewhere. However, it's so small that it's not likely the case there is a loss. In fact, if one were to add anything back to the model, we do not see a meaningful change so we are at a simplified model that represents the primary drivers.

```{r}
anova(modelMultiple3, modelMultiple4)
```

Model 2 (coded as modelMultiple4), is nested within Model 1 (modelMultiple3) because it has fewer predictors.

We're using an ANOVA test to determine whether the additional predictors in Model 1 explains significantly more variance than Model 2. With this output, we can safely fail to reject the null and the additional predictors do not provide a significant improvement of fit.

Out of curiosity, I just wanted to know if there was some interactions that could account for it and yes! That did lower the residuals and increase the r-squared value. A grand majority are not significant individually though.

```{r}
modelMultiple5 <- lm(weight ~ mage * visits * sex + mature + premie + marital, data = sampleBirths)
summary(modelMultiple5)
```

Regardless, there is a faster way to answer this question so, pulling out the MASS library for a step AIC.

```{r}
modelStepAll <- lm(weight ~ weeks + gained + mage + fage + visits + mature + premie + sex + habit + marital + whitemom, data = sampleBirths)
modelStepAIC <- stepAIC(modelStepAll, scope = . ~ .^11, direction = "both", trace = 0)
summary(modelStepAIC)
```

Super decreased residual (down to 0.669 lbs) and increased r-squared (up to 77% and 67% for adjusted), so pretty good. We would expect to predict the birth weight more precisely by using some interactions and is significant overall.

Of the interactions that are significant are:

-   fage:habitsmoker = 0.366; For babies born to smoking mothers, older fathers are associated with slightly lower birth weight, whereas for babies of non-smoking mothers, older fathers are associated with slightly higher birth weight.

-   visits:whitemomwhite = 0.2586; For babies of White mothers, more prenatal visits are associated with slightly higher birth weight, whereas for babies of non-White mothers, additional visits have a smaller effect.

-   fage:premiepremie = -0.1908; For premature babies, older fathers are associated with slightly lower birth weight, whereas for full-term babies, older fathers are associated with slightly higher birth weight.

-   gained:habitsmoker = 0.1387; For babies of smoking mothers, maternal weight gain is associated with a stronger increase in birth weight, whereas for babies of non-smoking mothers, weight gain has a smaller effect.

-   fage:whitemomwhite = -0.0925; For babies of White mothers, older fathers are associated with slightly lower birth weight, whereas for babies of non-White mothers, older fathers are associated with slightly higher birth weight.

-   weeks:mage = -0.0462; For older mothers, each additional week of gestation contributes slightly less to birth weight, whereas for younger mothers, each week contributes slightly more.

-   weeks:matureyounger mom = -0.5385; For babies of younger mothers, each additional week of gestation contributes less to birth weight, whereas for babies of mature mothers, each week contributes more.

-   gained:premiepremie = -0.1028; For premature babies, maternal weight gain contributes slightly less to birth weight, whereas for full-term babies, weight gain contributes more.

-   matureyounger mom:whitemomwhite = 1.4729; For babies of younger White mothers, birth weight is slightly higher than expected from maternal maturity or race alone, whereas for other combinations of maternal age and race, the effect is smaller.

However, because of this increased complexity, it could be harder to understand individual coefficients if one were to only report this version. The simpler version is better for reporting.

### Logistic

#### Which maternal, paternal, and pregnancy-related factors are associated with the likelihood of a baby being born with low birth weight?

```{r}
# simple logistic regression
simpleLog <- glm(lowbirthweight ~ mature, data = sampleBirths, family = "binomial")
print(summary(simpleLog), show.residuals = T)
```

For mature mothers, the estimated log-odds of a baby being of low weight is 2.565 so a probability of \~92%. Younger mothers see a slight decrease in the log-odds but this is not significant, being very similar to the mature mothers (\~91%). Naturally, on its own, this predictor is not significant.

```{r}
logModel <- glm(lowbirthweight ~ visits + gained + sex + marital + habit + mage + fage + mature + weeks, data = sampleBirths, family = "binomial")
print(summary(logModel), show.residuals = T)
```

Residual deviance is lower and thus indicates that this model fits better than an intercept-only one. But it does receive a warning indicating that some combinations are perfect predictions, which inflates coefficient magnitudes and SE.

Significant Predictors: weeks but since it is counterintuitive to believe that weeks would be associated with higher log-odds of low birth weight. It contradicts earlier analyses so there's likely some element of multicollinearity or a separation artifact, mentioned by the warning.

Marginally Significant Predictors:

-   visits: more prenatal visits tend to reduce the odds of low birth wight/

-   habitsmoker: smoking mothers has a large negative coefficient; best to assume that this is related to the quasi-complete separation.

-   fage: older fathers associated with slightly lower odds of low birthweight

-   mature younger mom: younger has a huge negative coefficient, likely separation

Others are not significant in effect but the SE are inflated.

The options that could be causing this multicollinearity or quasi-complete separation. There is an indication that multicollinearity is a concern (large coefficients, inflated SE and warning) when dealing with more than two variables at once but with consideration to the actual warning conferred, we're going to make a note of the potential for multicollinearity and progress with a Firth's Logistic Regression.

```{r multicollinearity}
vif(logModel)
```

```{r}
firthModel <- logistf(formula = lowbirthweight ~ visits + gained + sex + marital + 
    habit + mage + fage + mature + weeks, family = "binomial", 
    data = sampleBirths
)
summary(firthModel)
```

Aiming to reduce small sample bias and handle the quasi-complete separation. However, the warning is providing a similar concern in that some combinations still almost perfectly separate the outcomes and has the same side-effects.

We're going to try increasing iterations to 100 to see if that helps.

Update: Even going all the way up to 400 did not get the profile-likelihood CIs to converge for the variables that didn't. This did not help with the warnings so I accept that there are some predictors that are nearly separated in this dataset.

```{r}
firthModel <- logistf(formula = lowbirthweight ~ visits + gained + sex + marital + 
    habit + mage + fage + mature + weeks, family = "binomial", 
    data = sampleBirths,
    control = logistf.control(maxit = 100)
)
summary(firthModel)
```

Well, fair enough. I have a suspicion about what's causing the problem so before I attempt a step-wise selection, I am going to try that. To further my confirmation, I'm going to let the control go back to the default of 25.

```{r}
firthModel2 <- logistf(formula = lowbirthweight ~ visits + gained + sex + marital + 
    habit + mage + fage + mature, family = "binomial", 
    data = sampleBirths,
)
summary(firthModel2)
```

Aiming to reaffirm with the original model experiencing the problem.

```{r}
logModel <- glm(lowbirthweight ~ visits + gained + sex + marital + habit + mage + fage + mature, data = sampleBirths, family = "binomial")
print(summary(logModel), show.residuals = T)
```

Confirmed. The separation was driven by gestational age, effectively telling us that it has a strong structural relationship to lowbirthweight. It is nearly the perfect separation of outcomes.

It makes sense considering that conceptually, it would make sense for gestational age to be upstream of birth weight and its removal focuses the model on every other available features.

Fortunately that means there's no further need for predictor reduction or regularization.

Again, just to confirm, weeks alone can strongly predict outcome. It is so much so that its inclusion destabilizes models if attending to other associated factors, as it violates the assumption that no predictor comes so close to perfectly predicting the outcome.

```{r}
weeksOnlyModel <- glm(lowbirthweight ~ weeks, data = sampleBirths, family = "binomial")
print(summary(weeksOnlyModel), show.residuals = T)
```

```{r}
# calculate mcfadden's pseudo r^2

# pull log-likelihood of the null model (null deviance / -2)
ll.null <- weeksOnlyModel$null.deviance/-2

# pull log-likelihood for the larger model
ll.proposed <- weeksOnlyModel$deviance/-2

# pseudo
(ll.null - ll.proposed) / ll.null

# use to get p-value for the R^2 using a chi-square distribution
1 - pchisq(2*(ll.proposed - ll.null), df = (length(weeksOnlyModel$coefficients)-1))
```

McFadden's pseudo R\^2 indicates that the model with gestational age explains a substantial proportion of the variation, which is good improvement compared to the null (intercept only) model. The likelihood ratio test's, a chi-square test comparing the null and full model, p-value confirms the significance of improvement of model fit.

Returning to our stable model... sike, this will not perform, we will try again with the logistf version.

```{r}
# Get odds ratios and 95% CI
exp_coef <- exp(coef(logModel))
conf_int <- exp(confint(logModel))

# Combine into a nice table
logModelResults <- data.frame(
  Variable = names(exp_coef),
  OddsRatio = round(exp_coef, 3),
  CI_Lower = round(conf_int[,1], 3),
  CI_Upper = round(conf_int[,2], 3)
)

print(logModelResults)
```

```{r}
# Get odds ratios and 95% CI
exp_coef <- exp(coef(firthModel2))
conf_int <- exp(confint(firthModel2))

# Combine into a nice table
firthModel2Results <- data.frame(
  Variable = names(exp_coef),
  OddsRatio = round(exp_coef, 3),
  CI_Lower = round(conf_int[,1], 3),
  CI_Upper = round(conf_int[,2], 3)
)

print(firthModel2Results)
```

While weeks removed the major problem, the failure of the model to converge indicates that a complete or quasi-complete separation is present. Moving to a Firth's penalized logical regression model allows further progression because the coefficient estimates and confidence intervals are more reliable.

Now that diagnostics are done, we can continue. This is what I get for pressing forward despite being exhausted.

```{r}
# null model
modelNull = glm(lowbirthweight ~ 1, data = sampleBirths, family = "binomial")

# step model
step(modelNull, scope = list(upper = firthModel2),
     direction = "both",
     )

# Confusion matrix steps
# predicted probabilities and classes with threshold
sampleBirths$predictedProb <- predict(firthModel2, type = "response")
sampleBirths$predictedClass <- ifelse(sampleBirths$predictedProb >= 0.5, 1, 0)

# match length
length(sampleBirths$predictedClass)
length(sampleBirths$lowbirthweight)

# confusion matrix
table(Predicted = sampleBirths$predictedClass,
      Actual = sampleBirths$lowbirthweight)

```

Adding predictors based on AIC reductions. The additions, in order of greatest impact, are: habit, fage, visits, gained, mature. Smoking has a large negative coefficient, as do the rest but mature.

Babies born to smoking mothers, younger mothers or with lower maternal weight gain have higher likelihoods of being low birth weight. Higher paternal age and more prenatal visits are also associated with slightly increased low birth weight risk in this sample.

#### Which factors predict if the child will be born prematurely?

```{r all together now}
# null model
nullModelPremie <- glm(premie ~ 1, data = sampleBirths, family = "binomial")

# full model without weeks and weight
fullModelPremie <- glm(premie ~ visits + gained + habit + fage + mage + mature + sex + marital, data = sampleBirths, family = "binomial")
summary(fullModelPremie)

# separation check, firth's - not necessary to based on the the fact that it converges just fine
firthModelPremie <- logistf(premie ~ visits + gained + habit + fage + mage + mature + sex + marital, data = sampleBirths)
summary(firthModel)

# stepwise selection, starting with null then stepping up using AIC
stepModelPremie <- step(nullModelPremie, 
                  scope = list(upper = fullModelPremie), 
                  direction = "both")
summary(stepModelPremie)

# Odds ratios and 95% CI for final model, not using firth's yet
exp_coefPremie <- exp(coef(stepModelPremie))
conf_intPremie <- exp(confint(stepModelPremie))

logResultsPremie <- data.frame(
  Variable = names(exp_coef),
  OddsRatio = round(exp_coef, 3),
  CI_Lower = round(conf_int[,1], 3),
  CI_Upper = round(conf_int[,2], 3)
)

print(logResultsPremie)

# confusion matrix, class prediction with 0.5 cutoff
sampleBirths$predictedClassPremie <- ifelse(predict(stepModelPremie, type = "response") > 0.5, 1, 0)

table(Predicted = sampleBirths$predictedClassPremie, Actual = sampleBirths$premie)

```

# finish interpretation

## Conclusions:

(expected)

-   **Smoking Status**: smoker makes for lower birth weights

<!-- -->

-   **Gestation Period**: longer gestation makes for higher birth weight

<!-- -->

-   **Weight Gain**: Mothers who gained more weight make for higher birth weights.

<!-- -->

-   **Parental Age**: mage/fage association to birth weight, variable effects??

For my own interest:

-   since I did cut down to only 794 observations, a fun little side project could be learning to [augment data in R](https://www.r-bloggers.com/2016/10/what-you-need-to-know-about-data-augmentation-for-machine-learning/)

    -   either to fill in NA by some means or another

    -   double, maybe even triple the dataset

        -   perhaps with some kind of stratification (giving me more "smokers" data)
